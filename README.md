# Апи для отправки и анализа работ

Микросервисная система для управления учебными заданиями, загрузкой работ студентов и анализа плагиата.

Проект состоит из четырёх сервисов и API Gateway, через который проходит вся внешняя работа системы.
Каждый сервис выполняет строго выделенную роль и общается с другими через HTTP

---

# **Использование принципов Чистой Архитектуры**

Проект микросервисов построен на принципах **Clean Architecture**, что позволяет:

* отделять бизнес-логику от инфраструктуры,
* упрощать тестирование и расширение сервисов,
* минимизировать связанность компонентов,
* сохранять единообразие структуры между всеми сервисами (Tasks, Works, Analytics)

Каждый микросервис разделён на **строго определённые слои**, каждый из которых решает свою задачу

---

## **1. Domain layer (доменный слой)**

Содержит:

* бизнес-модели (`Task`, `WorkInfo`, `PlagiarismPair`),
* интерфейсы репозиториев,
* use-cases,
* чистую бизнес-логику

---

## **2. Data / Infra layer (инфраструктурный слой)**

*Реализация интерфейсов домена*

Содержит:

* реализацию репозиториев (Exposed DAO),
* клиентов других сервисов (HTTP-клиенты),
* таблицы БД,
* доступ к файловой системе,
* мапперы из DB-моделей в доменные модели,
* реализацию хранилища для готовых wordcloud-изображений (`WordCloudStorage`),
* реализацию клиента к внешнему API генерации облаков слов (QuickChart WordCloud API).

---

## **3. Presentation layer (слой представления / входа)**

*Routing + startup*

Содержит:

* Ktor routing (REST endpoints),
* обработку входящих запросов,
* DTO,
* валидацию входных данных,
* запуск приложения

---

## 4. DI

Каждый микросервис использует Koin для явного описания зависимостей:

* какие репозитории использовать,
* какой HTTP-клиент внедрять,
* какие use-cases доступны
* какие реализации `WordCloudStorage`, `WorkTextProvider` и клиента QuickChart использовать в Analytics Service

Это создаёт модульность и облегчает тестирование

---

## Архитектура проекта

Проект включает 4 микросервиса + API Gateway:

### **1. Task Service**

Отвечает за управление заданиями:

* создание задач;
* просмотр всех задач;
* просмотр конкретной задачи.

### **2. Work Service**

Работает с работами студентов:

* загрузка файлов (multipart/form-data);
* хранение файлов в общем томе Docker;
* выдача списка работ и работы по ID;
* вызов анализа при создании новой работы.

### **3. Analytics Service**

Отвечает за анализ работ:

* получение работы по ID из work-service;
* сравнение файлов (побайтово или по хэшу);
* определение случаев плагиата;
* хранение результатов анализа;
* выдача отчётов для отдельной работы или всех случаев плагиата;
* генерация облака слов по содержимому работы через внешний сервис QuickChart WordCloud API;
* сохранение сгенерированного облака слов в общий файловый том и возврат публичного URL на PNG-изображение.

### **4. API Gateway**

Единственная точка входа:

* маршрутизирует запросы к другим сервисам;
* отдаёт Swagger UI документацию;
* обрабатывает ошибки (например, если какой-то сервис недоступен);
* предоставляет единый HTTP-интерфейс для генерации облака слов по работе (`GET /works/{id}/wordcloud`), возвращая клиенту URL на статическое PNG-изображение.

---

## Используемые технологии

* **Kotlin** + **Ktor**
* **PostgreSQL**
* **Exposed ORM**
* **Koin DI**
* **Docker & Docker Compose**
* **Swagger UI**
* Внешний сервис **QuickChart WordCloud API** для генерации облаков слов

---

## Структура микросервисов

Каждый сервис имеет:

* свой Dockerfile,
* свой application.yml,
* свою базу данных,
* собственные доменные модели, use-case и слои.

Файлы работ хранятся в общем Docker Volume `works_uploads`, который монтируется и в work-service, и в analytics-service.

Сгенерированные изображения облаков слов хранятся в общем Docker Volume `wordclouds`, который монтируется и в analytics-service (для записи PNG-файлов), и в api-gateway (для чтения и раздачи этих файлов как статики).

---

## Как запустить проект

Требования:

* Docker
* Docker Compose

Запуск:

```bash
docker compose up --build
```

После запуска будут доступны:

| Компонент   | URL                                                            |
| ----------- | -------------------------------------------------------------- |
| API Gateway | [http://localhost:8080](http://localhost:8080)                 |
| Swagger UI  | [http://localhost:8080/swagger](http://localhost:8080/swagger) |

Все сервисы запускаются автоматически, включая нужные PostgreSQL базы.

---

### **Как работает проверка плагиата**

Analytics Service выполняет анализ следующим образом:

1. Загружает целевую работу и все остальные работы из Work Service.
2. Исключает сравнения:

    * если работа принадлежит тому же студенту.
3. Сравнивает файлы:

    * если содержимое полностью совпадает → `similarity = 100%`,
    * иначе вычисляет процент совпадающих байтов.
4. Если `similarity >= 80%`, результат считается плагиатом.
5. Сохраняет результат сравнения в базе analytics-service.
6. Отчёты можно запросить:

    * по конкретной работе: `/works/{id}/reports`
    * список всех плагиатов: `/reports/plagiarism`

---

### **Как работает генерация облака слов**

Генерация облака слов по работе реализована в Analytics Service поверх внешнего API QuickChart и общего тома с готовыми изображениями.

1. Клиент запрашивает облако слов для работы через API Gateway:
   `GET /works/{id}/wordcloud`.
2. Gateway проксирует запрос в Analytics Service.
3. Analytics Service:

    * получает метаданные работы по ID из Work Service (через HTTP-клиент);
    * через `WorkTextProvider` извлекает текст, который будет визуализирован:

        * для текстовых форматов — читает содержимое файла и нормализует текст (очищает от лишних символов, разбивает на слова),
        * для бинарных/нетекстовых форматов — читает байты файла и преобразует их в последовательность hex-«слов» (`A5`, `D8`, `01`, `FF` и т.д.);
    * формирует единый список «слов», разделённых запятыми (формат word list), который поддерживается QuickChart (`word1,word2,word3,...`);
    * вызывает QuickChart WordCloud API (`https://quickchart.io/wordcloud`) с параметрами:

        * `text=<список_слов_через_запятую>`,
        * `format=png`,
        * `useWordList=true` — указывает, что передан уже готовый список слов,
        * `cleanWords=false` — запрещает очистку и модификацию слов на стороне QuickChart,
        * `case=none` — сохраняет исходный регистр;
    * получает от QuickChart PNG-изображение облака слов;
    * сохраняет PNG-файл через `WordCloudStorage` в общий том `wordclouds` (например, с именем `work-{id}-wordcloud.png` в директории `/data/wordclouds`);
    * возвращает клиенту публичный URL вида `/static/work-{id}-wordcloud.png`, по которому API Gateway раздаёт изображение как статический файл.
4. API Gateway, имея настроенный статический роут для `/static` и смонтированный volume `wordclouds`, отдаёт готовое PNG-изображение по возвращённому URL.
5. Клиент может:

    * отобразить картинку напрямую в `<img src="...">`,
    * либо сохранить ссылку для последующего просмотра.

---

## Основные эндпоинты (через API Gateway)

### Tasks

* `GET /tasks` — получить все задания
* `POST /tasks` — создать задание
* `GET /tasks/{id}` — получить задание

### Works

* `POST /works` — отправить работу
* `GET /works` — фильтрация по студенту или заданию
* `GET /works/{id}` — получить работу

### Reports / Analytics

* `GET /works/{id}/reports` — отчёт по работе
* `GET /reports/plagiarism` — все случаи плагиата
* `GET /works/{id}/wordcloud` — сгенерировать облако слов по работе и получить URL на PNG-изображение облака слов

---

# Пользовательские технические сценарии микросервисов**

## **Сценарий 1 — Создание задания (Task Service)**

1. Клиент отправляет запрос в API Gateway:
   `POST /tasks`
2. Gateway проксирует запрос в Task Service.
3. Task Service:

    * валидирует данные,
    * создаёт запись в PostgreSQL,
    * возвращает созданное задание.
4. Gateway возвращает ответ клиенту.

---

## **Сценарий 2 — Студент загружает работу (Work Service -> Analytics Service)**

1. Клиент отправляет multipart-запрос в API Gateway:
   `POST /works`
2. Gateway проксирует его в Work Service.
3. Work Service выполняет:

    * сохраняет файл в общий Docker volume `works_uploads/`,
    * сохраняет метаданные работы в PostgreSQL,
    * возвращает данные созданной работы.
4. После успешного сохранения Work Service вызывает Analytics Service:
   `POST /internal/works/{id}/analyze`
5. Ответ Analytics не влияет на успешность создания работы.

---

## **Сценарий 3 — Анализ плагиата (Analytics Service)**

После вызова Work Service:

1. Analytics Service получает работу по ID:
   `GET http://works-service:8080/internal/works/{id}`
   (эту ручку ты уже создал)
2. Получает список всех остальных работ:
   `GET http://works-service:8080/internal/works`
3. Для каждой другой работы выполняет сравнение файлов.
4. Сохраняет результат сравнения в PostgreSQL:
    * workId1
    * workId2
    * similarityPercent
    * isPlagiarism
    * lastAnalyzedAt
5. Анализ завершается без ответа в сторону Work Service.

---

## **Сценарий 4 — Получение отчёта по работе**

1. Клиент делает запрос в Gateway:
   `GET /works/{id}/reports`
2. Gateway направляет его в Analytics Service.
3. Analytics Service ищет все пары работ, связанные с workId.
4. Возвращает список сравнений + вычисленный статус плагиата.
5. Gateway отдаёт ответ клиенту.

---

## **Сценарий 5 — Общий список всех случаев плагиата**

1. Клиент делает запрос:
   `GET /reports/plagiarism`
2. Gateway -> Analytics Service.
3. Analytics Service возвращает пары работ, где `isPlagiarism = true`.

---

## **Сценарий 6 — Получение списка или конкретной работы**

1. Клиент -> Gateway -> Work Service.
2. Work Service возвращает данные.

---

## **Сценарий 7 — Получение задач**

1. Клиент -> Gateway -> Task Service.
2. Task Service возвращает данные.

---

## **Сценарий 8 — Получение облака слов по работе**

1. Клиент отправляет запрос в API Gateway:
   `GET /works/{id}/wordcloud`
2. Gateway проксирует запрос в Analytics Service.
3. Analytics Service:
    * по ID работы запрашивает её метаданные и путь к файлу в Work Service;
    * с помощью `WorkTextProvider` получает текст для облака слов:
        * если файл текстовый — извлекает текст и преобразует его в список слов,
        * если файл бинарный — конвертирует байты файла в список hex-слов;
    * формирует строку со списком слов, разделённых запятыми (word list);
    * вызывает QuickChart WordCloud API с параметрами `format=png`, `useWordList=true`, `cleanWords=false`, `case=none`;
    * получает от QuickChart PNG-изображение и сохраняет его через `WordCloudStorage` в общий volume `wordclouds` под предсказуемым именем, привязанным к workId;
    * возвращает клиенту URL вида `/static/...png`.
4. API Gateway раздаёт изображение по этому URL как статический файл (baseUrl + это).
5. Клиент отображает облако слов, подставляя URL в строку поиска
